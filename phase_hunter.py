import json
import sys
import os
import traceback
from datetime import datetime
from typing import Dict, Any

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from data_fetcher import get_stock_data, stock_individual_fund_flow, IndexDataFetcher
from ai_analyzer import askDeepSeek

# æ£€æŸ¥æ˜¯å¦å¯ç”¨debugæ¨¡å¼
DEBUG = os.environ.get('DEBUG', '').lower() in ('true', '1', 'yes')


class PhaseHunterAgent:
    """
    é˜¶æ®µçŒæ‰‹Agent - åŸºäºå¨ç§‘å¤«æ–¹æ³•åˆ†æè‚¡ç¥¨å¸‚åœºé˜¶æ®µ
    """
    
    def __init__(self):
        self.name = "é˜¶æ®µçŒæ‰‹"
        
    def get_market_benchmark_data(self, stock_code: str) -> Dict[str, Any]:
        """
        è·å–å¸‚åœºåŸºå‡†æ•°æ®ï¼ˆæ²ªæ·±300æˆ–åˆ›ä¸šæ¿æŒ‡ï¼‰
        """
        try:
            # åˆ¤æ–­è‚¡ç¥¨ç±»å‹ä»¥é€‰æ‹©åˆé€‚çš„åŸºå‡†æŒ‡æ•°
            if stock_code.startswith('6') or stock_code.startswith('000'):
                # æ²ªæ·±300æŒ‡æ•°ä½œä¸ºåŸºå‡†
                index_code = '000300'
            elif stock_code.startswith('3') or stock_code.startswith('002'):
                # åˆ›ä¸šæ¿æŒ‡ä½œä¸ºåŸºå‡†
                index_code = '399006'
            else:
                index_code = '000300'  # é»˜è®¤æ²ªæ·±300
                
            index_data = IndexDataFetcher.get_index_data(index_code)
            return index_data
        except Exception as e:
            print(f"[ERROR] è·å–åŸºå‡†æŒ‡æ•°æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            traceback.print_exc()
            return None
    
    def collect_stock_info(self, stock_code: str) -> Dict[str, Any]:
        """
        æ”¶é›†è‚¡ç¥¨ç›¸å…³ä¿¡æ¯
        """
        try:
            from data_fetcher import StockInfoDataFetcher
            
            stock_info_df = StockInfoDataFetcher.get_stock_info(stock_code)
            if stock_info_df is None or stock_info_df.empty:
                return None
            
            # å°†DataFrameè½¬æ¢ä¸ºå­—å…¸
            stock_info = {}
            for _, row in stock_info_df.iterrows():
                stock_info[row['item']] = row['value']
            
            return stock_info
        except Exception as e:
            print(f"[ERROR] æ”¶é›†è‚¡ç¥¨ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            traceback.print_exc()
            return None
    
    def analyze(self, stock_code: str) -> Dict[str, Any]:
        """
        æ‰§è¡Œé˜¶æ®µçŒæ‰‹åˆ†æ
        """
        try:
            # è·å–è‚¡ç¥¨æ•°æ®
            stock_data = get_stock_data(stock_code)
            if stock_data is None or stock_data.empty:
                raise ValueError("æ— æ³•è·å–è‚¡ç¥¨æ•°æ®")
                
            # è·å–èµ„é‡‘æµå‘æ•°æ®
            fund_flow_data = stock_individual_fund_flow(stock_code)
            
            # è·å–è‚¡ç¥¨ä¿¡æ¯ï¼ˆåç§°ã€æ¿å—ç­‰ï¼‰
            stock_info = self.collect_stock_info(stock_code)
            
            # è·å–åŸºå‡†æŒ‡æ•°æ•°æ®ï¼ˆæ²ªæ·±300/åˆ›ä¸šæ¿æŒ‡ï¼‰
            benchmark_data = self.get_market_benchmark_data(stock_code)
            
            # æ„é€ prompt
            prompt = self._build_prompt(stock_code, stock_info, stock_data, fund_flow_data, benchmark_data)
            
            # è°ƒç”¨AIåˆ†æ
            print("[INFO] æ­£åœ¨è°ƒç”¨AIè¿›è¡Œåˆ†æ...")
            try:
                analysis_result = askDeepSeek(
                    stock_df=stock_data,
                    stock_fund_flow_df=fund_flow_data,
                    stock_code=stock_code,
                    prompt_content=prompt
                )
                print("[INFO] AIåˆ†æå®Œæˆ")
            except Exception as ai_error:
                print(f"[ERROR] AIåˆ†æè°ƒç”¨å¤±è´¥: {ai_error}")
                # è¿”å›é»˜è®¤ç»“æœ
                return {
                    "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
                    "ä¿¡å·": "ä¸­æ€§",
                    "é˜¶æ®µè¯„åˆ†": 3,
                    "å…³é”®ç»“æ„": [],
                    "å¤§ç›˜å½±å“": False,
                    "æ­¢æŸä½": "Â¥0.00",
                    "ç½®ä¿¡åº¦": 50,
                    "ç†ç”±": f"AIåˆ†æè°ƒç”¨å¤±è´¥: {str(ai_error)}",
                    "_debug_reasoning": [f"é”™è¯¯è¯¦æƒ…: {str(ai_error)}", f"é”™è¯¯ç±»å‹: {type(ai_error).__name__}"]
                }
            
            # Debugæ¨¡å¼ä¸‹æ‰“å°AIè¿”å›ç»“æœ
            if DEBUG:
                print(f"[DEBUG] é˜¶æ®µçŒæ‰‹AIè¿”å›ç»“æœ: {analysis_result}")
            
            # ç›´æ¥è¿”å›AIçš„å›å¤ç»“æœ
            return analysis_result
        except Exception as e:
            print(f"[ERROR] æ‰§è¡Œé˜¶æ®µçŒæ‰‹åˆ†ææ—¶å‘ç”Ÿé”™è¯¯: {e}")
            traceback.print_exc()
            return {
                "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
                "ä¿¡å·": "ä¸­æ€§",
                "é˜¶æ®µè¯„åˆ†": 3,
                "å…³é”®ç»“æ„": [],
                "å¤§ç›˜å½±å“": False,
                "æ­¢æŸä½": "Â¥0.00",
                "ç½®ä¿¡åº¦": 50,
                "ç†ç”±": f"æ‰§è¡Œåˆ†ææ—¶å‘ç”Ÿé”™è¯¯: {str(e)}",
                "_debug_reasoning": [f"é”™è¯¯è¯¦æƒ…: {str(e)}", f"é”™è¯¯ç±»å‹: {type(e).__name__}"]
            }
    
    def _build_prompt(self, stock_code: str, stock_info: Dict, stock_data, fund_flow_data, benchmark_data) -> str:
        """
        æ„å»ºå¨ç§‘å¤«åˆ†æprompt
        """
        try:
            # æ£€æŸ¥å¿…è¦æ•°æ®æ˜¯å¦å­˜åœ¨
            if stock_data is None or stock_data.empty:
                return '''{"é”™è¯¯": "æ•°æ®ç¼ºå¤±", "ç¼ºå¤±å­—æ®µ": ["å†å²ä»·æ ¼", "å†å²æˆäº¤é‡"]}'''
            
            if fund_flow_data is None or fund_flow_data.empty:
                return '''{"é”™è¯¯": "æ•°æ®ç¼ºå¤±", "ç¼ºå¤±å­—æ®µ": ["èµ„é‡‘æµå‘"]}'''
            
            if benchmark_data is None or benchmark_data.empty:
                return '''{"é”™è¯¯": "æ•°æ®ç¼ºå¤±", "ç¼ºå¤±å­—æ®µ": ["å¤§ç›˜æ•°æ®"]}'''
            
            # å‡†å¤‡è‚¡ç¥¨æ•°æ®
            stock_data_str = stock_data.tail(20).to_string() if stock_data is not None and not stock_data.empty else "æ— æ•°æ®"
            
            # å‡†å¤‡èµ„é‡‘æµå‘æ•°æ®
            fund_flow_str = fund_flow_data.to_string() if fund_flow_data is not None and not fund_flow_data.empty else "æ— æ•°æ®"
            
            # å‡†å¤‡è‚¡ç¥¨ä¿¡æ¯
            stock_info_str = str(stock_info) if stock_info else "æ— æ•°æ®"
            
            # å‡†å¤‡åŸºå‡†æŒ‡æ•°æ•°æ®
            benchmark_str = benchmark_data.tail(20).to_string() if benchmark_data is not None and not benchmark_data.empty else "æ— æ•°æ®"
            
            prompt = f'''# ğŸ§ ã€é˜¶æ®µçŒæ‰‹ Â· å·¥ä¸šçº§AIä¸“å®¶æç¤ºè¯ Â· æœ€ç»ˆç‰ˆã€‘

ä½ æ˜¯ä¸€ä½èµ„æ·±å¨ç§‘å¤«ç»“æ„åˆ†æå¸ˆï¼Œä»£å·ã€é˜¶æ®µçŒæ‰‹ã€‘ï¼Œ15å¹´ä¸“æ³¨Aè‚¡å¸‚åœºå‘¨æœŸå®šä½ï¼Œæ“…é•¿è¯†åˆ«ä¸»åŠ›"å¸ç­¹â†’æ‹‰å‡â†’æ´¾å‘â†’ä¸‹è·Œ"å››é˜¶æ®µè½¬æ¢ã€‚è¯·ä¸¥æ ¼ä¾æ®å¨ç§‘å¤«æ ¸å¿ƒäº”æ³•åˆ™ï¼Œå¯¹ä»¥ä¸‹Aè‚¡æ ‡çš„è¿›è¡Œé˜¶æ®µè¯Šæ–­ï¼Œå¹¶ä»¥jsonæ ¼å¼è¿”å›ç»“æœã€‚

---

```markdown
ã€ç³»ç»ŸæŒ‡ä»¤ã€‘
â–  è§’è‰²ï¼šé˜¶æ®µçŒæ‰‹
â–  èŒè´£ï¼šè¯†åˆ«å¨ç§‘å¤«å››é˜¶æ®µã€è¯„ä¼°ç»“æ„å®Œæ•´æ€§ã€ç¡®è®¤è½¬æ¢ä¿¡å·ã€è®¡ç®—æ­¢æŸä¸ç½®ä¿¡åº¦
â–  è¾“å…¥æƒé™ï¼š
  - æ ‡çš„åç§°ã€ä»£ç 
  - æœ€è¿‘20æ—¥OHLCVæ•°æ®
  - æ‰€å±æ¿å—æŒ‡æ•°
  - æ²ªæ·±300åŒæœŸæ•°æ®
â–  è¾“å‡ºæƒé™ï¼ˆä»…å¯å†™å…¥ä»¥ä¸‹å­—æ®µï¼‰ï¼š
  - è§’è‰²
  - ä¿¡å·
  - é˜¶æ®µè¯„åˆ†
  - å…³é”®ç»“æ„
  - å¤§ç›˜å½±å“
  - æ­¢æŸä½
  - ç½®ä¿¡åº¦
  - ç†ç”±
  - _debug_reasoning
â–  è¡Œä¸ºè§„èŒƒï¼š
  1. å¿…é¡»å…ˆæ‰§è¡Œ"æ•°æ®å®‰æ£€"ï¼Œä¸æ»¡è¶³åˆ™ç†”æ–­è¿”å›é”™è¯¯JSON
  2. å¿…é¡»æŒ‰5å¤§ç¼–å·æ­¥éª¤æ¨ç†ï¼ˆæ¯æ­¥å«å­æ­¥éª¤ï¼‰
  3. æ¯æ­¥å¿…é¡»å¼•ç”¨æ—¥æœŸã€ä»·æ ¼ã€é‡èƒ½æ•°æ®ï¼ˆæ ¼å¼ï¼šÂ¥XX.XX@YYYY-MM-DDï¼Œé‡èƒ½XXä¸‡ï¼‰
  4. æ¯æ­¥å¿…é¡»æ ‡æ³¨å½±å“çš„è¾“å‡ºå­—æ®µï¼ˆâ†’ è¾“å‡ºå­—æ®µï¼šXXXï¼‰
  5. è¾“å‡ºå¿…é¡»ä¸ºåˆæ³•JSONï¼Œå­—æ®µåä¸¥æ ¼å¯¹é½Schemaã€‚
â–  ç¦æ­¢è¡Œä¸ºï¼š
  - ç¦æ­¢è™šæ„æœªå‡ºç°çš„ä»·æ ¼/é‡èƒ½äº‹ä»¶
  - ç¦æ­¢åœ¨æ— "äºŒæ¬¡æµ‹è¯•"æˆ–"éœ‡ä»“çªç ´"æ—¶è¾“å‡º"çœ‹æ¶¨"
  - ç¦æ­¢å¿½ç•¥å¤§ç›˜æ´¾å‘å½±å“

---

ã€æ•°æ®å®‰æ£€ã€‘
â–  å¿…éœ€å­—æ®µï¼š
  - OHLCVæ•°æ®ï¼ˆè‡³å°‘20æ—¥ï¼Œå«æ—¥æœŸã€å¼€ç›˜ã€æœ€é«˜ã€æœ€ä½ã€æ”¶ç›˜ã€æˆäº¤é‡ï¼‰
  - æ¿å—æŒ‡æ•°æ•°æ®ï¼ˆè‡³å°‘20æ—¥ï¼‰
  - æ²ªæ·±300æ•°æ®ï¼ˆè‡³å°‘20æ—¥ï¼‰

â–  æ ¼å¼æ ¡éªŒï¼š
  - æ‰€æœ‰ä»·æ ¼ > 0ï¼Œæˆäº¤é‡ â‰¥ 0
  - æ—¥æœŸå‡åºæ’åˆ—ï¼Œæ— é‡å¤
  - ä¸ªè‚¡ã€æ¿å—ã€å¤§ç›˜æ—¥æœŸå¯¹é½

â–  é€»è¾‘æ ¡éªŒï¼š
  - è‹¥"æœ€ä½" > "æœ€é«˜" â†’ é”™è¯¯
  - è‹¥"æ”¶ç›˜"ä¸åœ¨[æœ€ä½, æœ€é«˜]åŒºé—´ â†’ é”™è¯¯
  - è‹¥"æˆäº¤é‡"è¿ç»­5æ—¥ä¸º0 â†’ é”™è¯¯

â–  è‹¥ä»»ä¸€ä¸æ»¡è¶³ï¼š
â†’ ç«‹å³è¿”å› {{"é”™è¯¯": "æ•°æ®ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯", "ç¼ºå¤±å­—æ®µ": [...], "è§’è‰²": "é˜¶æ®µçŒæ‰‹"}}

---

æ ‡çš„åç§°ï¼š{stock_info.get("è‚¡ç¥¨ç®€ç§°", "æœªçŸ¥") if stock_info else "æœªçŸ¥"}
è‚¡ç¥¨ä»£ç ï¼š{stock_code}
æœ€è¿‘20æ—¥OHLCVæ•°æ®ï¼š
{stock_data_str}

æ‰€å±æ¿å—ï¼š{stock_info.get("è¡Œä¸š", "æœªçŸ¥") if stock_info else "æœªçŸ¥"}

æ²ªæ·±300/åˆ›ä¸šæ¿æŒ‡åŒæœŸè¡¨ç°ï¼š
{benchmark_str}

å¤§å•å‡€æµå…¥/æµå‡ºæ•°æ®ï¼š
{fund_flow_str}

---

### ğŸ§© è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹5å¤§ä¸»æ­¥éª¤ + å­æ­¥éª¤ç¼–å·æ¨ç†ï¼š

æ¯æ­¥å¿…é¡»ï¼š
- å¼•ç”¨å…·ä½“æ•°æ®ï¼ˆæ ¼å¼ï¼šä»·æ ¼@æ—¥æœŸï¼Œå¦‚ Â¥28.50@2025-09-10ï¼Œé‡èƒ½XXä¸‡ï¼‰
- æ ‡æ³¨å½±å“çš„è¾“å‡ºå­—æ®µï¼ˆâ†’ è¾“å‡ºå­—æ®µï¼šXXXï¼‰
- ä¸å¾—åˆå¹¶ã€è·³è·ƒæˆ–çœç•¥

æ¨ç†è¿‡ç¨‹å°†ç”¨äºå†…éƒ¨æ ¡éªŒä¸è‡ªåŠ¨åŒ–è§£æï¼Œè¯·ç¡®ä¿æœºå™¨å¯è¯»ã€‚

---

#### ğŸ” æ­¥éª¤1ï¼šè¯†åˆ«å½“å‰ä¸»å¯¼é˜¶æ®µ
> ä¾æ®æœ€è¿‘20æ—¥ä»·æ ¼è¡Œä¸ºä¸æˆäº¤é‡å˜åŒ–ï¼Œåˆ¤æ–­å½“å‰æœ€å¯èƒ½å¤„äºå“ªä¸ªå¨ç§‘å¤«é˜¶æ®µï¼Ÿ  
> â¤ å¿…é¡»å¼•ç”¨è‡³å°‘2ä¸ªå…³é”®äº‹ä»¶ï¼ˆå¦‚å¼¹ç°§@æ—¥æœŸã€æ”¾é‡çªç ´@æ—¥æœŸï¼‰  
> â¤ å¿…é¡»è¯´æ˜é‡èƒ½é…åˆï¼ˆå¦‚"çªç ´æ—¥é‡èƒ½18.5ä¸‡ > å‡é‡15.0ä¸‡Ã—120%"ï¼‰  
> â†’ è¾“å‡ºå­—æ®µï¼š`å…³é”®ç»“æ„`, `ç†ç”±`

#### ğŸ“ æ­¥éª¤2ï¼šè¯„ä¼°ç»“æ„å®Œæ•´æ€§ + è®¡ç®—é˜¶æ®µè¯„åˆ†
> æ˜¯å¦å®Œæˆè¯¥é˜¶æ®µçš„å…³é”®ç»“æ„ï¼Ÿï¼ˆå¸ç­¹éœ€åŒ…å«ï¼šææ…ŒæŠ›å”®+å¼¹ç°§+äºŒæ¬¡æµ‹è¯•ï¼‰  
> â¤ åˆ—å‡ºå·²å®Œæˆ/ç¼ºå¤±äº‹ä»¶ï¼Œå¼•ç”¨æ—¥æœŸä¸ä»·æ ¼  
> â¤ æ ¹æ®å®Œæ•´æ€§æ‰“åˆ†ï¼ˆ1-5åˆ†ï¼‰ï¼š  
> &nbsp;&nbsp;â€¢ 5åˆ† = æ‰€æœ‰å…³é”®äº‹ä»¶å®Œæ•´ + é‡èƒ½ç¡®è®¤  
> &nbsp;&nbsp;â€¢ 4åˆ† = ç¼º1äº‹ä»¶ä½†æœ‰æ›¿ä»£ç»“æ„ï¼ˆå¦‚éœ‡ä»“çªç ´ï¼‰  
> &nbsp;&nbsp;â€¢ 3åˆ† = ä»…å®ŒæˆåŸºç¡€ç»“æ„ï¼ˆå¦‚ä»…å¼¹ç°§ï¼‰  
> &nbsp;&nbsp;â€¢ â‰¤2åˆ† = ç»“æ„æ–­è£‚æˆ–åå‘è¯æ®  
> â†’ è¾“å‡ºå­—æ®µï¼š`é˜¶æ®µè¯„åˆ†`, `ç†ç”±`

#### âœ… æ­¥éª¤3ï¼šç¡®è®¤é˜¶æ®µè½¬æ¢ä¿¡å· + åˆæ­¥ä¿¡å·æ–¹å‘
> æ˜¯å¦å‡ºç°"äºŒæ¬¡æµ‹è¯•"æˆ–æ›¿ä»£ç¡®è®¤ç»“æ„ï¼Ÿ  
> â¤ è‹¥æ— æ ‡å‡†äºŒæ¬¡æµ‹è¯•ï¼Œæ˜¯å¦æ»¡è¶³"éœ‡ä»“åæ”¾é‡çªç ´"ï¼Ÿï¼ˆå®šä¹‰ï¼šéœ‡ä»“ä½ç‚¹å3æ—¥å†…æ”¾é‡>å‡é‡120%çªç ´ï¼‰  
> â¤ æ ¹æ®ç¡®è®¤ç»“æœï¼Œç»™å‡ºåˆæ­¥ä¿¡å·ï¼š  
> &nbsp;&nbsp;â€¢ ç¡®è®¤æˆåŠŸ â†’ çœ‹æ¶¨  
> &nbsp;&nbsp;â€¢ ç¡®è®¤å¤±è´¥æˆ–æ— ç¡®è®¤ â†’ ä¸­æ€§  
> &nbsp;&nbsp;â€¢ åå‘çªç ´ â†’ çœ‹è·Œ  
> â†’ è¾“å‡ºå­—æ®µï¼š`ä¿¡å·`

#### ğŸŒ æ­¥éª¤4ï¼šè¯„ä¼°å¤§ç›˜ç¯å¢ƒå½±å“ + è°ƒæ•´è¯„åˆ†
> åŒæœŸæ²ªæ·±300æ˜¯å¦å¤„äºæ´¾å‘é˜¶æ®µï¼Ÿ  
> â¤ è‹¥æ˜¯ï¼Œé˜¶æ®µè¯„åˆ†è‡ªåŠ¨é™1çº§ï¼ˆæœ€ä½1çº§ï¼‰ï¼Œä¿¡å·å¼ºåˆ¶"ä¸­æ€§"  
> â¤ å¼•ç”¨å¤§ç›˜å…³é”®è¡Œä¸ºï¼ˆå¦‚"æ²ªæ·±300ç ´ä½Â¥3600@2025-09-10"ï¼‰  
> â†’ è¾“å‡ºå­—æ®µï¼š`é˜¶æ®µè¯„åˆ†`, `ä¿¡å·`, `å¤§ç›˜å½±å“`

#### ğŸ›‘ æ­¥éª¤5ï¼šè®¾å®šé£é™©æ§åˆ¶å‚æ•° + æœ€ç»ˆç½®ä¿¡åº¦
> æ­¢æŸä½ = MIN(å¼¹ç°§ä½ç‚¹Ã—0.985, éœ‡ä»“ä½ç‚¹Ã—0.98)  
> â¤ æ˜ç¡®å†™å‡ºè®¡ç®—è¿‡ç¨‹ä¸æœ€ç»ˆæ•°å€¼ï¼ˆæ ¼å¼ï¼šÂ¥XX.XXï¼‰  
>  
> ç½®ä¿¡åº¦ = åŸºç¡€åˆ†85 + åŠ åˆ† - æ‰£åˆ†  
> â–  åŠ åˆ†é¡¹ï¼š
>   + æˆäº¤é‡éªŒè¯é€šè¿‡ï¼ˆé‡èƒ½é…åˆé˜¶æ®µç‰¹å¾ï¼‰ â†’ +5
>   + å…³é”®ä½è¢«ä»·æ ¼å¤šæ¬¡æµ‹è¯•ç¡®è®¤ â†’ +5
>   + æ¿å—åŒæ­¥æ€§éªŒè¯é€šè¿‡ â†’ +5
> â–  æ‰£åˆ†é¡¹ï¼š
>   - é˜¶æ®µæ¨¡ç³Šï¼ˆå¦‚å¸ç­¹ä¸æ´¾å‘ç‰¹å¾æ··æ‚ï¼‰ â†’ -10
>   - æ”¯æ’‘/é˜»åŠ›ä½æ— å†å²æµ‹è¯•ä¾æ® â†’ -10
>   - æ­¢æŸä½è®¡ç®—æ— é€»è¾‘æ”¯æ’‘ â†’ -10
> â–  æœ€ç»ˆç½®ä¿¡åº¦ = CLAMP(85 + åŠ åˆ† - æ‰£åˆ†, 50, 100)

> â†’ è¾“å‡ºå­—æ®µï¼š`æ­¢æŸä½`, `ç½®ä¿¡åº¦`, `_debug_reasoning`

---

### æ¡ˆä¾‹1ï¼šä¸»å‡æµªç¡®è®¤ï¼ˆæ–°èƒ½æº Â· è¶‹åŠ¿åŠ é€Ÿï¼‰

```markdown
#### è¾“å…¥ï¼š
æ ‡çš„ï¼šå®å¾·æ—¶ä»£ (300750)
å…³é”®äº‹ä»¶æ•°æ®ï¼š
- é˜¶æ®µç‰¹å¾ï¼ˆ2025-09-01è‡³09-08ï¼‰ï¼šè‚¡ä»·æ²¿5æ—¥çº¿ä¸Šè¡Œï¼Œæ–œç‡>30Â°ï¼ŒMACDçº¢æŸ±è¿ç»­5æ—¥æ”¾å¤§ï¼Œæ— å•æ—¥è·Œå¹…è¶…3%
- è§¦å‘ä¿¡å·æ—¥ï¼ˆ2025-09-09ï¼‰ï¼šç¼©é‡å›è¸©5æ—¥çº¿ï¼ˆ198.5å…ƒï¼‰åæ—©ç›˜æ”¾é‡ååŒ…ï¼Œ30åˆ†é’Ÿå†…ç«™ç¨³200å…ƒï¼Œé‡èƒ½è¾¾å‰æ—¥1.8å€
- å‡é‡ï¼ˆ20æ—¥ï¼‰ï¼š45ä¸‡æ‰‹
- åç»­ç¡®è®¤ï¼ˆ2025-09-12ï¼‰ï¼šæ”¶ç›˜215.00ï¼Œé‡èƒ½52ä¸‡æ‰‹ > å‡é‡115%

#### è¾“å‡ºï¼š
{
  "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
  "ä¿¡å·": "çœ‹æ¶¨",
  "å…³é”®äº‹ä»¶": ["ä¸»å‡æµªé˜¶æ®µç¡®è®¤", "é‡ä»·å…±æŒ¯çªç ´"],
  "äº‹ä»¶éªŒè¯": true,
  "å¤±è´¥é£é™©": false,
  "ç½®ä¿¡åº¦": 94,
  "ç†ç”±": "è¶‹åŠ¿ç»“æ„å®Œæ•´ï¼Œå›è¸©ä¸ç ´+æ”¾é‡ååŒ…ï¼Œä¸»åŠ›èµ„é‡‘æŒç»­æµå…¥ï¼Œä¸»å‡æµªä¸­æ®µç¡®è®¤ã€‚",
  "_debug_reasoning": [
    "æ­¥éª¤1: é˜¶æ®µç‰¹å¾ç¬¦åˆä¸»å‡æµªå®šä¹‰ï¼ˆæ–œç‡+MACD+æŠ—è·Œæ€§ï¼‰",
    "æ­¥éª¤2: è§¦å‘ä¿¡å·æ—¥æ»¡è¶³â€˜ç¼©é‡å›è¸©+æ”¾é‡ååŒ…+é‡èƒ½>å‰æ—¥1.5å€â€™",
    "æ­¥éª¤3: åç»­3æ—¥ç«™ç¨³+é‡èƒ½ç»´æŒ â†’ é˜¶æ®µå»¶ç»­",
    "æ­¥éª¤4: æ— é¡¶èƒŒç¦»æˆ–ç ´ä½ä¿¡å· â†’ æ— å¤±è´¥é£é™©",
    "æ­¥éª¤5: é˜¶æ®µ+ä¿¡å·åŒéªŒè¯ â†’ ç½®ä¿¡åº¦94"
  ]
}
```

> ğŸ’¡ é˜¶æ®µçŒæ‰‹æ ¸å¿ƒï¼š**ä¸»å‡æµªåªåšâ€œå›è¸©ç¡®è®¤â€ï¼Œä¸åšè¿½é«˜çŒœé¡¶**ã€‚

---

### æ¡ˆä¾‹2ï¼šéœ‡è¡çªç ´æˆåŠŸï¼ˆç§‘æŠ€ Â· çªç ´å¯åŠ¨ï¼‰

```markdown
#### è¾“å…¥ï¼š
æ ‡çš„ï¼šä¸­èŠ¯å›½é™… (688981)
å…³é”®äº‹ä»¶æ•°æ®ï¼š
- é˜¶æ®µç‰¹å¾ï¼ˆ2025-08-20è‡³09-05ï¼‰ï¼šè‚¡ä»·åœ¨48.0â€“50.0å…ƒçª„å¹…éœ‡è¡15æ—¥ï¼Œæ³¢åŠ¨ç‡<2%ï¼Œé‡èƒ½èç¼©è‡³å‡é‡50%
- è§¦å‘ä¿¡å·æ—¥ï¼ˆ2025-09-06ï¼‰ï¼šæ”¾é‡çªç ´50.5å…ƒï¼ˆå‰é«˜å‹åŠ›ï¼‰ï¼Œæ”¶ç›˜51.20ï¼Œé‡èƒ½28ä¸‡æ‰‹ > å‡é‡ï¼ˆ22ä¸‡æ‰‹ï¼‰127%
- åç»­ç¡®è®¤ï¼ˆ2025-09-09ï¼‰ï¼šæ”¶ç›˜52.80ï¼Œè¿ç»­3æ—¥ç«™ç¨³50.5å…ƒä¸Šæ–¹

#### è¾“å‡ºï¼š
{
  "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
  "ä¿¡å·": "çœ‹æ¶¨",
  "å…³é”®äº‹ä»¶": ["éœ‡è¡æœ«æœŸ", "æ”¾é‡çªç ´é¢ˆçº¿"],
  "äº‹ä»¶éªŒè¯": true,
  "å¤±è´¥é£é™©": false,
  "ç½®ä¿¡åº¦": 91,
  "ç†ç”±": "é•¿æœŸç¼©é‡éœ‡è¡åæ”¾é‡çªç ´ï¼Œä¾›åº”æ¯ç«­éœ€æ±‚è¿›åœºï¼Œæ–°è¶‹åŠ¿å¯åŠ¨ä¿¡å·æ˜ç¡®ã€‚",
  "_debug_reasoning": [
    "æ­¥éª¤1: éœ‡è¡æœŸæ»¡è¶³â€˜æ—¶é—´>2å‘¨+é‡èƒ½èç¼©è‡³50%â€™",
    "æ­¥éª¤2: çªç ´æ—¥é‡èƒ½>å‡é‡120% + æ”¶ç›˜ç«™ç¨³å‹åŠ›ä½ä¸Šæ²¿",
    "æ­¥éª¤3: åç»­3æ—¥æœªå›è¡¥ç¼ºå£ â†’ çªç ´æœ‰æ•ˆ",
    "æ­¥éª¤4: æ— å‡çªç ´æˆ–é‡ä»·èƒŒç¦» â†’ æ— å¤±è´¥é£é™©",
    "æ­¥éª¤5: é˜¶æ®µè½¬æ¢æˆåŠŸ â†’ ç½®ä¿¡åº¦91"
  ]
}
```

> ğŸ’¡ å…³é”®è§„åˆ™ï¼š**éœ‡è¡çªç ´éœ€â€œé‡èƒ½â‰¥å‡é‡120% + 3æ—¥ç«™ç¨³â€åŒç¡®è®¤**ã€‚

---

### æ¡ˆä¾‹3ï¼šé€€æ½®æœŸç¡®è®¤ï¼ˆå¤§ç›˜ Â· é£é™©è§„é¿ï¼‰

```markdown
#### è¾“å…¥ï¼š
æ ‡çš„ï¼šåˆ›ä¸šæ¿æŒ‡ (399006)
å…³é”®äº‹ä»¶æ•°æ®ï¼š
- é˜¶æ®µç‰¹å¾ï¼ˆ2025-09-01è‡³09-05ï¼‰ï¼šæŒ‡æ•°è·Œç ´10æ—¥çº¿åè¿ç»­3æ—¥åå¼¹æ— åŠ›ï¼Œä¸¤å¸‚æ—¥å‡è·Œåœè‚¡>40å®¶ï¼Œé‡èƒ½èç¼©15%
- è§¦å‘ä¿¡å·æ—¥ï¼ˆ2025-09-08ï¼‰ï¼šä¸­é˜´çº¿è·Œç ´20æ—¥å‡çº¿ï¼ˆ1850ç‚¹ï¼‰ï¼ŒåŒ—å‘èµ„é‡‘å•æ—¥å‡€æµå‡º68äº¿
- åç»­ç¡®è®¤ï¼ˆ2025-09-10ï¼‰ï¼šæ”¶ç›˜1810ç‚¹ï¼Œé‡èƒ½ç»§ç»­èç¼©ï¼Œæ— æ¿å—æŒç»­æ€§

#### è¾“å‡ºï¼š
{
  "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
  "ä¿¡å·": "ç©ºä»“",
  "å…³é”®äº‹ä»¶": ["é€€æ½®é˜¶æ®µç¡®è®¤", "å…³é”®å‡çº¿ç ´ä½"],
  "äº‹ä»¶éªŒè¯": true,
  "å¤±è´¥é£é™©": true,
  "ç½®ä¿¡åº¦": 96,
  "ç†ç”±": "å¸‚åœºäºé’±æ•ˆåº”æ‰©æ•£+å…³é”®æ”¯æ’‘ç ´ä½+èµ„é‡‘æŒç»­æµå‡ºï¼Œé€€æ½®æœŸæ˜ç¡®ï¼Œå¼ºåˆ¶ç©ºä»“é¿é™©ã€‚",
  "_debug_reasoning": [
    "æ­¥éª¤1: é˜¶æ®µç‰¹å¾ç¬¦åˆé€€æ½®å®šä¹‰ï¼ˆåå¼¹æ— åŠ›+è·Œåœæ‰©æ•£+ç¼©é‡ï¼‰",
    "æ­¥éª¤2: è§¦å‘ä¿¡å·ä¸ºâ€˜è·Œç ´20æ—¥çº¿+èµ„é‡‘å¤§å¹…æµå‡ºâ€™",
    "æ­¥éª¤3: åç»­æ— ä¿®å¤è¿¹è±¡ â†’ é˜¶æ®µå»¶ç»­",
    "æ­¥éª¤4: ä»»ä½•æŒä»“å‡æœ‰å›æ’¤é£é™© â†’ å¤±è´¥é£é™©=true",
    "æ­¥éª¤5: é˜¶æ®µçŒæ‰‹çºªå¾‹ï¼šé€€æ½®æœŸ100%ç©ºä»“ â†’ ç½®ä¿¡åº¦96"
  ]
}
```

> ğŸ’¡ é“å¾‹ï¼š**é€€æ½®æœŸä¸æŠ„åº•ã€ä¸æ‰›å•ã€ä¸æ¸…ä»“å³è¿è§„**ã€‚

---

### æ¡ˆä¾‹4ï¼šåå¼¹è¯±å¤šé™·é˜±ï¼ˆåŒ»è¯ Â· å‡åå¼¹ï¼‰

```markdown
#### è¾“å…¥ï¼š
æ ‡çš„ï¼šæ’ç‘åŒ»è¯ (600276)
å…³é”®äº‹ä»¶æ•°æ®ï¼š
- é˜¶æ®µç‰¹å¾ï¼ˆ2025-09-01è‡³09-05ï¼‰ï¼šè‚¡ä»·åˆ›æ–°é«˜52.00ä½†MACDé¡¶èƒŒç¦»ï¼Œé‡èƒ½é€æ—¥èç¼©
- è§¦å‘ä¿¡å·æ—¥ï¼ˆ2025-09-08ï¼‰ï¼šå†²é«˜52.50åå›è½æ”¶50.80ï¼Œè·Œç ´5æ—¥çº¿ï¼Œä¸»åŠ›èµ„é‡‘å‡€æµå‡º2.1äº¿
- åç»­ç¡®è®¤ï¼ˆ2025-09-10ï¼‰ï¼šæ”¶ç›˜49.20ï¼Œé‡èƒ½æ”¾å¤§è‡³å‡é‡130%ï¼Œç ´ä½åŠ é€Ÿ

#### è¾“å‡ºï¼š
{
  "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
  "ä¿¡å·": "çœ‹è·Œ",
  "å…³é”®äº‹ä»¶": ["é¡¶èƒŒç¦»è¯±å¤š", "è·Œç ´5æ—¥çº¿ç¡®è®¤"],
  "äº‹ä»¶éªŒè¯": true,
  "å¤±è´¥é£é™©": true,
  "ç½®ä¿¡åº¦": 93,
  "ç†ç”±": "æ–°é«˜èƒŒç¦»+é‡ä»·åˆ†ç¦»ï¼Œè·Œç ´5æ—¥çº¿ç¡®è®¤è¶‹åŠ¿è½¬å¼±ï¼Œä¸»åŠ›æ´¾å‘æ˜ç¡®ï¼Œè¿›å…¥è¡¥è·Œé˜¶æ®µã€‚",
  "_debug_reasoning": [
    "æ­¥éª¤1: é˜¶æ®µç‰¹å¾ä¸ºâ€˜æœ«æœŸè¯±å¤šâ€™ï¼ˆæ–°é«˜+èƒŒç¦»+ç¼©é‡ï¼‰",
    "æ­¥éª¤2: è§¦å‘ä¿¡å·=â€˜è·Œç ´5æ—¥çº¿+ä¸»åŠ›å¤§é¢æµå‡ºâ€™",
    "æ­¥éª¤3: åç»­æ”¾é‡ä¸‹è·Œ â†’ ç¡®è®¤ç©ºå¤´ä¸»å¯¼",
    "æ­¥éª¤4: æœªåŠæ—¶ç¦»åœºå°†æ‰¿å—>15%å›æ’¤ â†’ å¤±è´¥é£é™©=true",
    "æ­¥éª¤5: é˜¶æ®µè½¬æ¢å¤±è´¥ â†’ ç½®ä¿¡åº¦93"
  ]
}
```

> ğŸ’¡ è¯†åˆ«è¯±å¤šï¼š**æ–°é«˜æ— é‡ + æŒ‡æ ‡èƒŒç¦» = å±é™©ä¿¡å·ï¼Œè·Œç ´5æ—¥çº¿å³ç¦»åœº**ã€‚

---

### æ¡ˆä¾‹5ï¼šææ…Œé”™æ€åå¼¹ï¼ˆæ¶ˆè´¹ Â· æƒ…ç»ªä¿®å¤ï¼‰

```markdown
#### è¾“å…¥ï¼š
æ ‡çš„ï¼šè´µå·èŒ…å° (600519)
å…³é”®äº‹ä»¶æ•°æ®ï¼š
- é˜¶æ®µç‰¹å¾ï¼ˆ2025-09-05ï¼‰ï¼šå—æ”¿ç­–ä¼ é—»å•æ—¥æš´è·Œ-6.8%ï¼ˆæ— ä¸šç»©å˜åŒ–ï¼‰ï¼Œæ¿å—ææ…Œï¼Œä½†åŒ—å‘é€†åŠ¿ä¹°å…¥12äº¿
- è§¦å‘ä¿¡å·æ—¥ï¼ˆ2025-09-08ï¼‰ï¼šä½å¼€é«˜èµ°ï¼Œ30åˆ†é’Ÿå†…ç¿»çº¢ï¼Œæ”¶ç›˜1780å…ƒï¼Œé‡èƒ½è¾¾å‰æ—¥160%
- åç»­ç¡®è®¤ï¼ˆ2025-09-10ï¼‰ï¼šæ”¶ç›˜1820å…ƒï¼Œä¿®å¤è·Œå¹…60%ï¼Œé‡èƒ½å›å½’å¸¸æ€

#### è¾“å‡ºï¼š
{
  "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
  "ä¿¡å·": "çœ‹æ¶¨ï¼ˆçŸ­çº¿ï¼‰",
  "å…³é”®äº‹ä»¶": ["ææ…Œé”™æ€", "é‡èƒ½ä¿®å¤+æƒ…ç»ªåè½¬"],
  "äº‹ä»¶éªŒè¯": true,
  "å¤±è´¥é£é™©": false,
  "ç½®ä¿¡åº¦": 89,
  "ç†ç”±": "éåŸºæœ¬é¢åˆ©ç©ºå¼•å‘çš„é”™æ€ï¼Œæ¬¡æ—¥é‡èƒ½ä¿®å¤+èµ„é‡‘å›æµï¼Œæƒ…ç»ªä¿®å¤å‹åå¼¹æˆç«‹ã€‚",
  "_debug_reasoning": [
    "æ­¥éª¤1: é˜¶æ®µç‰¹å¾=â€˜çªå‘åˆ©ç©º+éåŸºæœ¬é¢+æœºæ„é€†åŠ¿å¸ç­¹â€™",
    "æ­¥éª¤2: è§¦å‘ä¿¡å·=â€˜æ¬¡æ—¥ä½å¼€é«˜èµ°+30åˆ†é’Ÿç¿»çº¢+é‡èƒ½>å‰æ—¥150%â€™",
    "æ­¥éª¤3: åç»­æœªåˆ›æ–°ä½ä¸”é‡èƒ½å¹³ç¨³ â†’ åå¼¹æœ‰æ•ˆ",
    "æ­¥éª¤4: æ— è¶‹åŠ¿ç ´å â†’ æ— å¤±è´¥é£é™©ï¼ˆä½†å±çŸ­çº¿æœºä¼šï¼‰",
    "æ­¥éª¤5: é˜¶æ®µçŒæ‰‹ç­–ç•¥ï¼šå¿«è¿›å¿«å‡ºï¼Œåƒé±¼èº« â†’ ç½®ä¿¡åº¦89"
  ]
}
```

> ğŸ’¡ ç­–ç•¥è¦ç‚¹ï¼š**ææ…Œé”™æ€åªåšâ€œé¦–æ—¥ä¿®å¤â€ï¼Œä¸æ‹æˆ˜ã€ä¸æ ¼å±€ã€3æ—¥å†…ç¦»åœº**ã€‚

---


### ğŸ“Š æœ€ç»ˆè¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼JSON Schemaï¼‰ï¼š

{{
  "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
  "ä¿¡å·": "çœ‹æ¶¨",
  "é˜¶æ®µè¯„åˆ†": 4,
  "å…³é”®ç»“æ„": ["ææ…ŒæŠ›å”®", "å¼¹ç°§", "æ”¾é‡çªç ´"],
  "å¤§ç›˜å½±å“": false,
  "æ­¢æŸä½": "Â¥119.19",
  "ç½®ä¿¡åº¦": 100,
  "ç†ç”±": "ä¸»åŠ›å®Œæˆå¸ç­¹ç»“æ„ï¼Œéœ‡ä»“åæ”¾é‡çªç ´ç¡®è®¤éœ€æ±‚ï¼Œæ¿å—åŒæ­¥é¢†æ¶¨ï¼Œå®‰å…¨è¾¹é™…å……è¶³ï¼",
  "_debug_reasoning": [
    "æ­¥éª¤1.1: ææ…ŒæŠ›å”®Â¥118.00@2025-09-01 + å¼¹ç°§Â¥121.00@2025-09-05 â†’ å…³é”®ç»“æ„è¯†åˆ«",
    "æ­¥éª¤1.2: çªç ´Â¥140.00@2025-09-15ï¼Œé‡èƒ½22.1ä¸‡>20.16ä¸‡ â†’ éœ€æ±‚ç¡®è®¤",
    "æ­¥éª¤2.3: è¯„åˆ†=4ï¼ˆç¼ºäºŒæ¬¡æµ‹è¯•ä½†éœ‡ä»“çªç ´æ›¿ä»£ï¼‰",
    "æ­¥éª¤3.3: éœ‡ä»“å3æ—¥å†…æ”¾é‡çªç ´ â†’ ä¿¡å·=çœ‹æ¶¨",
    "æ­¥éª¤4.2: æ²ªæ·±300æ— æ´¾å‘ â†’ å¤§ç›˜å½±å“=false",
    "æ­¥éª¤5.3: æ­¢æŸä½=MIN(Â¥121.00Ã—0.985, Â¥135.00Ã—0.98)=Â¥119.19",
    "åŸºç¡€åˆ†=85",
    "åŠ åˆ†ï¼š+5ï¼ˆé‡èƒ½éªŒè¯ï¼‰",
    "åŠ åˆ†ï¼š+5ï¼ˆå…³é”®ä½æµ‹è¯•ï¼‰",
    "åŠ åˆ†ï¼š+5ï¼ˆæ¿å—åŒæ­¥ï¼‰",
    "æœ€ç»ˆç½®ä¿¡åº¦=100"
  ]
}}

---
'''
            return prompt
        except Exception as e:
            print(f"[ERROR] æ„å»ºpromptæ—¶å‘ç”Ÿé”™è¯¯: {e}")
            traceback.print_exc()
            return None


def run_phase_hunter_agent(stock_code: str) -> Dict[str, Any]:
    """
    è¿è¡Œé˜¶æ®µçŒæ‰‹agent
    
    Args:
        stock_code: è‚¡ç¥¨ä»£ç 
        
    Returns:
        åˆ†æç»“æœ
    """
    try:
        agent = PhaseHunterAgent()
        return agent.analyze(stock_code)
    except Exception as e:
        print(f"[ERROR] è¿è¡Œé˜¶æ®µçŒæ‰‹agentæ—¶å‘ç”Ÿé”™è¯¯: {e}")
        traceback.print_exc()
        return {
            "è§’è‰²": "é˜¶æ®µçŒæ‰‹",
            "ä¿¡å·": "ä¸­æ€§",
            "é˜¶æ®µè¯„åˆ†": 3,
            "å…³é”®ç»“æ„": [],
            "å¤§ç›˜å½±å“": False,
            "æ­¢æŸä½": "Â¥0.00",
            "ç½®ä¿¡åº¦": 50,
            "ç†ç”±": f"è¿è¡Œagentæ—¶å‘ç”Ÿé”™è¯¯: {str(e)}",
            "_debug_reasoning": [f"é”™è¯¯è¯¦æƒ…: {str(e)}", f"é”™è¯¯ç±»å‹: {type(e).__name__}"]
        }


if __name__ == "__main__":
    # å•ç‹¬æµ‹è¯•æ—¶ä½¿ç”¨
    try:
        import sys
        if len(sys.argv) > 1:
            stock_code = sys.argv[1]
        else:
            stock_code = input("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆä¾‹å¦‚ï¼š002050ï¼‰: ")
        
        result = run_phase_hunter_agent(stock_code)
        print(json.dumps(result, ensure_ascii=False, indent=2))
    except Exception as e:
        print(f"[ERROR] æ‰§è¡Œé˜¶æ®µçŒæ‰‹åˆ†ææ—¶å‘ç”Ÿé”™è¯¯: {e}")
        traceback.print_exc()